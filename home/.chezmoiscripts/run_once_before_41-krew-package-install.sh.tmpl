{{- $krew_file := joinPath .chezmoi.sourceDir (print "_packages/krew." .chezmoi.os) -}}
{{- $krew_index_file := joinPath .chezmoi.sourceDir (print "_packages/krew-index." .chezmoi.os) -}}
#!/usr/bin/env bash
{{- if or (stat $krew_file) (stat $krew_index_file) }}
{{- if (stat $krew_file) }}
# Hash krew file {{ include $krew_file | sha256sum }}
{{- end }}
{{- if (stat $krew_index_file) }}
# Hash krew-index file {{ include $krew_index_file | sha256sum }}
{{- end }}

function is_krew_installed() {
  which krew > /dev/null
}

function run_krew_command() {
  $(which krew) "$@"
}

function update_krew_plugins() {
  echo "Updating krew plugins..."
  run_krew_command "update" &> /dev/null
  run_krew_command "upgrade" &> /dev/null
}

function strip_comments_from_file() {
  sed -e 's/[[:space:]]*#.*// ; /^[[:space:]]*$/d' "$1"
}

function is_krew_index_installed() {
  run_krew_command "index" "list" | grep "$1" &> /dev/null
}

function is_krew_plugin_installed() {
  run_krew_command "list" | grep "$1" &> /dev/null
}

function install_krew_index() {
  echo "Installing krew index $1 ($2)"
  run_krew_command "index" "add" "$1" "$2" &> /dev/null
}

function install_krew_plugin() {
  echo "Installing krew plugin $1"
  run_krew_command "install" "$1"
}

function process_krew_index_file() {
  if [ -f "{{ $krew_index_file }}" ]; then
    while read -r line
    do
      IFS=" " read -r krew_index_name krew_index_url <<< "$line"
      if ! is_krew_index_installed "${krew_index_url}"; then
        install_krew_index "${krew_index_name}" "${krew_index_url}"
      fi
    done < <(strip_comments_from_file "{{ $krew_index_file }}")
  fi
}

function process_krew_file() {
  if [ -f "{{ $krew_file }}" ]; then
    while read -r krew_plugin
    do
      if ! is_krew_plugin_installed "${krew_plugin}"; then
        install_krew_plugin "${krew_plugin}"
      fi
    done < <(strip_comments_from_file "{{ $krew_file }}")
  fi
}

function main() {
  if is_krew_installed ; then
    process_krew_index_file
    process_krew_file
    update_krew_plugins
  fi
}

if [ ${#BASH_SOURCE[@]} = 1 ]; then
  main
fi
{{- end }}
